
library(mice)
library(ggthemes)

indicators_ps <- c("I am an important part of the University community",
  "I am comfortable asking questions in diverse settings",
  "I have adequate time for creative thought",
  "I seek opportunities to work outside of my main area of expertise",
  "Innovation is rewarded in our current institutional structure",
  "It is encouraged to put new “high risk” ideas forward at work",
  "Mistakes are accepted as a critical part of learning in our work environment",
  "My input is sought when institutional decisions are being made",
  "My unique strengths are valued at work",
  "My work-life integration is optimal",
  "The environment at work is very competitive")

psych_safety <-  elam_long_inner %>%
  select(-Name, -starts_with("At this time")|contains(indicators_ps)|contains("Email")) %>%
  group_by("Email") %>%
  rowid_to_column(var = "Respondent") %>%
  ungroup() %>%
  gather(key = Item, 
         value = Agreement, 
         -c(Respondent, "Email")) %>%
  mutate(Agreement = str_replace_all(Agreement, 
                                     "Neither Agree not Disagree", 
                                     "Neither Agree nor Disagree")) %>%
  mutate(Measure = case_when(
    Agreement == "Strongly Agree" ~ 4,
    Agreement == "Agree" ~ 3,
    Agreement == "Neither Agree nor Disagree" ~ 2,
    Agreement == "Disagree" ~ 1,
    Agreement == "Strongly Disagree" ~ 0
  )) %>%
  filter(str_detect(Agreement, 'agree')) %>% 
  separate(Item, c('Item', 'Timepoint'), sep="_") %>%
  mutate(Timepoint = case_when(
      Timepoint == "1" ~ "t1",
      Timepoint == "2" ~ "t2"
      )
    ) %>%
  separate(Item, c('QID', 'Item'), sep="  ") %>%
  arrange(Respondent) %>%
  group_by(Respondent, Item) %>%
  mutate(Group_ID = cur_group_id()) %>%
  ungroup() %>%
  select(Group_ID, Timepoint, Measure) %>%
  rowid_to_column(var = "row_number") %>%
  pivot_wider(id_cols = Group_ID,
              names_from = Timepoint, 
              values_from = Measure) %>%
  arrange(Group_ID)


psych_data <- psych_safety %>%
  select(t1, t2) 

md.pattern(psych_data) 

md.pairs(psych_data)

psych_data.imp_zero <- mice(psych_data, maxit=0)
predM_data.imp_zero <- psych_data.imp_zero$predictorMatrix
meth_data.imp_zero <- psych_data.imp_zero$method

psych_data.imp <- mice(psych_data, 
                       maxit = 10, 
                       predictorMatrix = predM_data.imp_zero, 
                       method = meth_data.imp_zero, 
                       print =  FALSE)

head(psych_data.imp$imp$t1)
head(psych_data.imp$imp$t2)

# Extract the "tall" matrix which stacks the imputations
psych_data.comp_long <- complete(psych_data.imp, "long", include = TRUE)

table(psych_data.comp_long$.imp)

psych_data.comp_long$t1.NA <- cci(ttest_data$t1)
 
head(psych_data.comp_long[, c("t1", "t1.NA")])

ggplot(psych_data.comp_long, 
       aes(x = .imp, 
           y = t1, 
           color = t1.NA)) + 
  scale_color_manual(values = c("#d9534f", "#428bca")) +
  theme_hc() +
  geom_jitter(show.legend = FALSE, 
              width = 0.2,
              cex = 0.6)

# descriptives ----
with(psych_data.imp, mean(t1))
with(psych_data.imp, mean(t2))
